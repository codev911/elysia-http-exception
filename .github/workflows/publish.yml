name: ðŸ“¦ Build & Publish

on:
  push:
    tags:
      - 'v*.*.*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., patch, minor, major, or specific version like 1.2.3)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor  
          - major
          - prerelease
      npm_tag:
        description: 'NPM dist-tag (latest, beta, alpha, next)'
        required: false
        default: 'latest'
        type: choice
        options:
          - latest
          - beta
          - alpha
          - next
      dry_run:
        description: 'Dry run (build without publishing)'
        required: false
        default: false
        type: boolean

# Ensure only one publish workflow runs at a time
concurrency:
  group: publish
  cancel-in-progress: false

env:
  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

jobs:
  # Job 1: Pre-publish Checks
  pre-checks:
    name: ðŸ” Pre-publish Checks
    runs-on: ubuntu-latest
    if: github.repository == 'codev911/elysia-http-exception'
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŸ¢ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ðŸ“¦ Install Dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ”¨ Build Package
        run: |
          echo "Building package for production..."
          bun run build
          echo "âœ… Build completed successfully"

      - name: ðŸ“¦ Install Example Dependencies
        working-directory: ./example
        run: bun install --frozen-lockfile

      - name: ðŸ§ª Run Full Test Suite
        run: |
          echo "Running comprehensive test suite before publish..."
          bun test:unit
          bun test:e2e
          echo "âœ… All tests passed"

      - name: ðŸ“‹ Validate Build Output
        run: |
          echo "Validating build artifacts..."
          test -f dist/index.js || (echo "âŒ Missing dist/index.js" && exit 1)
          test -f dist/index.d.ts || (echo "âŒ Missing dist/index.d.ts" && exit 1)
          
          # Check if main exports are present
          node -e "
            const pkg = require('./dist/index.js');
            if (!pkg.httpExceptionPlugin) throw new Error('Missing httpExceptionPlugin export');
            if (!pkg.HttpException) throw new Error('Missing HttpException export'); 
            if (!pkg.BadRequestException) throw new Error('Missing BadRequestException export');
            console.log('âœ… All main exports are present');
          "
          
          echo "âœ… Build validation completed"

      - name: ðŸ·ï¸ Determine Version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag push
            VERSION=${GITHUB_REF#refs/tags/v}
            TAG="latest"
            IS_PRERELEASE="false"
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            # GitHub release
            VERSION=${{ github.event.release.tag_name }}
            VERSION=${VERSION#v}
            if [[ "${{ github.event.release.prerelease }}" == "true" ]]; then
              TAG="beta"
              IS_PRERELEASE="true"
            else
              TAG="latest"
              IS_PRERELEASE="false"
            fi
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual trigger
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            if [[ "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              VERSION="${{ inputs.version }}"
            else
              # Use npm version to calculate new version
              npm version --no-git-tag-version ${{ inputs.version }}
              VERSION=$(node -p "require('./package.json').version")
            fi
            TAG="${{ inputs.npm_tag }}"
            if [[ "$TAG" != "latest" ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          else
            echo "âŒ Unsupported trigger event"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT  
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ Publishing version: $VERSION with tag: $TAG"

  # Job 2: Publish to npm
  publish-npm:
    name: ðŸ“¦ Publish to npm
    runs-on: ubuntu-latest
    needs: pre-checks
    if: github.repository == 'codev911/elysia-http-exception' && !inputs.dry_run
    
    environment: 
      name: npm
      url: https://www.npmjs.com/package/elysia-http-exception
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŸ¢ Setup Bun  
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ðŸ“¦ Install Dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ”¨ Build Package
        run: bun run build

      - name: ðŸ“ Update Package Version
        run: |
          # Update package.json version using Node
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${{ needs.pre-checks.outputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            console.log('âœ… Package version updated to ${{ needs.pre-checks.outputs.version }}');
          "

      - name: ðŸ” Pre-publish Dry Run
        run: |
          echo "Running publish dry run..."
          # Create .npmrc for authentication
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc
          # Use npm to create tarball and test
          npm pack
          echo "âœ… Dry run completed successfully"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸ“¤ Publish to npm
        run: |
          echo "Publishing to npm registry..."
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc
          # Use npx for publishing since bun publish is experimental
          npx npm@latest publish --tag ${{ needs.pre-checks.outputs.tag }} --access public
          echo "âœ… Successfully published to npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸ·ï¸ Tag Latest Version
        if: needs.pre-checks.outputs.tag == 'latest'
        run: |
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc
          npx npm@latest dist-tag add elysia-http-exception@${{ needs.pre-checks.outputs.version }} latest
          echo "âœ… Tagged as latest on npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Job 3: Publish to GitHub Packages  
  publish-github:
    name: ðŸ“¦ Publish to GitHub Packages
    runs-on: ubuntu-latest
    needs: pre-checks
    if: github.repository == 'codev911/elysia-http-exception' && !inputs.dry_run
    
    permissions:
      contents: read
      packages: write
    
    environment:
      name: github-packages
      url: https://github.com/codev911/elysia-http-exception/packages
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ðŸ”§ Setup Node.js for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@codev911'

      - name: ðŸ“¦ Install Dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ”¨ Build Package
        run: bun run build

      - name: ðŸ“ Update Package for GitHub Packages
        run: |
          # Update package.json for GitHub Packages
          npm version --no-git-tag-version ${{ needs.pre-checks.outputs.version }}
          
          # Update name for GitHub packages
          node -e "
            const pkg = require('./package.json');
            pkg.name = '@codev911/elysia-http-exception';
            pkg.publishConfig = {
              registry: 'https://npm.pkg.github.com',
              access: 'public'
            };
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2));
          "
          
          echo "âœ… Package configured for GitHub Packages"

      - name: ðŸ“¤ Publish to GitHub Packages
        run: |
          echo "Publishing to GitHub Packages..."
          npm publish --tag ${{ needs.pre-checks.outputs.tag }}
          echo "âœ… Successfully published to GitHub Packages"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 4: Create GitHub Release
  github-release:
    name: ðŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [pre-checks, publish-npm]
    if: github.repository == 'codev911/elysia-http-exception' && !inputs.dry_run && github.event_name != 'release'
    
    permissions:
      contents: write
      
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“‹ Generate Release Notes
        id: changelog
        run: |
          VERSION="${{ needs.pre-checks.outputs.version }}"
          
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [[ -n "$LATEST_TAG" ]]; then
            echo "Generating changelog from $LATEST_TAG to HEAD"
            CHANGELOG=$(git log $LATEST_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "No previous tags found, generating changelog from first commit"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Create release notes
          cat > release_notes.md << EOF
          ## ðŸš€ What's New in v$VERSION
          
          ### ðŸ“‹ Changes
          $CHANGELOG
          
          ### ðŸ“¦ Installation
          \`\`\`bash
          # Using bun (recommended)
          bun add elysia-http-exception@$VERSION
          
          # Using npm
          npm install elysia-http-exception@$VERSION
          \`\`\`
          
          ### ðŸ“š Documentation
          - [README](https://github.com/codev911/elysia-http-exception#readme)
          - [Examples](https://github.com/codev911/elysia-http-exception/tree/main/example)
          - [npm Package](https://www.npmjs.com/package/elysia-http-exception)
          
          ### ðŸ™ Contributors
          Thank you to all contributors who made this release possible!
          EOF
          
          echo "release_notes_file=release_notes.md" >> $GITHUB_OUTPUT

      - name: ðŸš€ Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.pre-checks.outputs.version }}
          release_name: ðŸš€ Release v${{ needs.pre-checks.outputs.version }}
          body_path: ${{ steps.changelog.outputs.release_notes_file }}
          draft: false
          prerelease: ${{ needs.pre-checks.outputs.is-prerelease }}

  # Job 5: Post-publish Tasks
  post-publish:
    name: ðŸ“‹ Post-publish Tasks
    runs-on: ubuntu-latest
    needs: [pre-checks, publish-npm, publish-github, github-release]
    if: always() && github.repository == 'codev911/elysia-http-exception' && !inputs.dry_run
    
    steps:
      - name: ðŸ“‹ Publish Summary
        run: |
          echo "## ðŸŽ‰ Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Published Version: **${{ needs.pre-checks.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ Dist Tag: **${{ needs.pre-checks.outputs.tag }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.publish-npm.result }}" == "success" ]]; then
            echo "âœ… **npm Registry**: Successfully published" >> $GITHUB_STEP_SUMMARY
            echo "   - ðŸ”— [View on npm](https://www.npmjs.com/package/elysia-http-exception/v/${{ needs.pre-checks.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **npm Registry**: Failed to publish" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.publish-github.result }}" == "success" ]]; then
            echo "âœ… **GitHub Packages**: Successfully published" >> $GITHUB_STEP_SUMMARY
            echo "   - ðŸ”— [View on GitHub](https://github.com/codev911/elysia-http-exception/packages)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **GitHub Packages**: Failed to publish" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.github-release.result }}" == "success" ]]; then
            echo "âœ… **GitHub Release**: Successfully created" >> $GITHUB_STEP_SUMMARY
            echo "   - ðŸ”— [View Release](https://github.com/codev911/elysia-http-exception/releases/tag/v${{ needs.pre-checks.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **GitHub Release**: Failed to create" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ› ï¸ Installation Command:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "bun add elysia-http-exception@${{ needs.pre-checks.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸŽ‰ Success Notification
        if: needs.publish-npm.result == 'success' && needs.publish-github.result == 'success'
        run: |
          echo "ðŸŽ‰ Successfully published elysia-http-exception v${{ needs.pre-checks.outputs.version }} to both npm and GitHub Packages!"
          echo "ðŸ“¦ npm: https://www.npmjs.com/package/elysia-http-exception/v/${{ needs.pre-checks.outputs.version }}"
          echo "ðŸ“¦ GitHub: https://github.com/codev911/elysia-http-exception/packages"

      - name: âš ï¸ Partial Success Warning
        if: (needs.publish-npm.result == 'success') != (needs.publish-github.result == 'success')
        run: |
          echo "âš ï¸ Partial publish success - some registries failed"
          echo "Please check the individual job results and consider manual intervention if needed."

      - name: âŒ Publish Failed  
        if: needs.publish-npm.result != 'success' && needs.publish-github.result != 'success'
        run: |
          echo "âŒ Publish failed for both registries"
          echo "Please check the logs and retry the publish process."
          exit 1

  # Job 6: Dry Run Summary (if enabled)
  dry-run-summary:
    name: ðŸ§ª Dry Run Summary
    runs-on: ubuntu-latest
    needs: pre-checks
    if: inputs.dry_run && github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ðŸ“‹ Dry Run Results
        run: |
          echo "## ðŸ§ª Dry Run Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Version that would be published: **${{ needs.pre-checks.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ Dist tag that would be used: **${{ needs.pre-checks.outputs.tag }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Pre-checks**: All validations passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build**: Package built successfully" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Tests**: All tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Ready for publish!** Disable dry run to proceed with actual publishing." >> $GITHUB_STEP_SUMMARY
